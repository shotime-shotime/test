<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>INTERNAL WHISTLEBLOWER - MOBILE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    * { -webkit-tap-highlight-color: transparent; outline: none; }
    
    body { 
        background: #000; color: #0f0; font-family: 'Press Start 2P', cursive; 
        margin: 0; padding: 0; overflow: hidden; touch-action: none;
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; width: 100vw;
    }

    /* „Ç≤„Éº„É†ÁîªÈù¢„ÇíÂõ≤„ÅÜÊû†Ôºà„Åì„ÅÆ‰∏≠Ë∫´„ÅåËá™ÂãïÊã°Â§ß„Åï„Çå„ÇãÔºâ */
    #game-wrapper { 
        position: relative; width: 900px; height: 650px; 
        background: #000; border: 4px solid #0f0; box-sizing: border-box;
        display: flex; flex-direction: column; overflow: hidden;
    }

    .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; background: #000; }
    .hidden { display: none !important; }

    /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº */
    .header { 
        width: 100%; height: 70px; display: flex; justify-content: space-around; align-items: center; 
        background: #111; border-bottom: 2px solid #0f0; font-size: 12px; z-index: 5;
    }
    .stat-val { color: #fff; font-size: 16px; margin-left: 5px; }

    canvas { background: #050505; display: block; z-index: 1; }

    /* „É¢„Éê„Ç§„É´„Ç≥„É≥„Éà„É≠„Éº„É©„Éº */
    #mobile-ui { 
        position: absolute; bottom: 20px; width: 100%; display: flex; 
        justify-content: space-between; padding: 0 40px; box-sizing: border-box; z-index: 20; 
    }
    .dpad { display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 8px; }
    .t-btn { 
        background: rgba(0, 255, 0, 0.2); border: 2px solid #0f0; color: #0f0; 
        display: flex; align-items: center; justify-content: center; font-size: 30px; 
        border-radius: 12px; pointer-events: auto;
    }
    .t-btn:active { background: rgba(0, 255, 0, 0.5); }
    
    .action-btn { 
        width: 120px; height: 120px; border-radius: 50%; border: 4px solid #ff0; 
        color: #ff0; background: rgba(255, 255, 0, 0.1); 
        display: flex; align-items: center; justify-content: center; font-size: 16px;
    }
    .action-btn:active { background: rgba(255, 255, 0, 0.4); }

    /* „Éú„Çø„É≥„Éª„ÉÜ„Ç≠„Çπ„Éà */
    .btn { background: #111; color: #0f0; border: 3px solid #0f0; padding: 20px; margin: 10px; font-family: inherit; width: 400px; font-size: 16px; }
    .rank-box { font-size: 12px; color: #888; width: 80%; line-height: 1.8; margin-top: 15px; }
    .rank-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; }
</style>
</head>
<body>

<div id="game-wrapper">
    <div id="screen-title" class="screen">
        <h1 style="font-size:30px; text-align:center;">INTERNAL<br>WHISTLEBLOWER</h1>
        <p style="font-size:12px;">AGENT: <span id="my-name" style="color:#fff;"></span></p>
        <div id="mission-list"></div>
    </div>

    <div id="screen-ready" class="screen hidden">
        <h2 id="ready-mission-name">MISSION</h2>
        <div id="mission-ranking" class="rank-box"></div>
        <button class="btn" onclick="startGame()">START MISSION</button>
        <button class="btn" style="width:200px; font-size:12px;" onclick="showScreen('title')">BACK</button>
    </div>

    <div id="screen-game" class="screen hidden" style="justify-content: flex-start;">
        <div class="header">
            <div>üìÅ<span id="ev-val" class="stat-val">0/0</span></div>
            <div>üß†<span id="mtl-val" class="stat-val">100</span></div>
            <div id="item-slot" style="color:#ff0;">ITEM: EMPTY</div>
            <div>‚è±Ô∏è<span id="time-val" class="stat-val">0.0</span></div>
        </div>
        <canvas id="gameCanvas" width="900" height="430"></canvas>
        <div id="mobile-ui">
            <div class="dpad">
                <div class="t-btn" style="grid-column:2" onpointerdown="keys.Up=true" onpointerup="keys.Up=false" onpointerleave="keys.Up=false">‚ñ≤</div>
                <div class="t-btn" style="grid-column:1; grid-row:2" onpointerdown="keys.Left=true" onpointerup="keys.Left=false" onpointerleave="keys.Left=false">‚óÄ</div>
                <div class="t-btn" style="grid-column:3; grid-row:2" onpointerdown="keys.Right=true" onpointerup="keys.Right=false" onpointerleave="keys.Right=false">‚ñ∂</div>
                <div class="t-btn" style="grid-column:2; grid-row:3" onpointerdown="keys.Down=true" onpointerup="keys.Down=false" onpointerleave="keys.Down=false">‚ñº</div>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="action-btn" onpointerdown="useItem()">ITEM</div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen hidden">
        <h1 id="result-title">RESULT</h1>
        <p id="result-text" style="font-size:20px;"></p>
        <div id="final-ranking" class="rank-box"></div>
        <button class="btn" onclick="showScreen('title')">TO TITLE</button>
    </div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let keys = { Up: false, Down: false, Left: false, Right: false };

// --- „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö ---
const adj = ["Èùô„Åã„Å™", "Ë¨é„ÅÆ", "‰ºùË™¨„ÅÆ", "‰∏çÂ±à„ÅÆ", "ÂΩ±„ÅÆ"];
const job = ["‰øÇÈï∑", "„Éè„ÉÉ„Ç´„Éº", "„Çπ„Éë„Ç§", "Ë®òËÄÖ"];
let myCodename = sessionStorage.getItem('n') || (adj[Math.floor(Math.random()*5)] + job[Math.floor(Math.random()*4)]);
sessionStorage.setItem('n', myCodename);
document.getElementById('my-name').textContent = myCodename;

const missions = [
    { id: "m1", title: "MISSION 1: Âñ∂Ê•≠„Éï„É≠„Ç¢", floors: [
        { target: 3, bosses: [{t:'Ë™≤Èï∑', n:2, s:3.2, p:0.5, sz:30}], walls: [{x:400,y:0,w:40,h:320}] },
        { target: 4, bosses: [{t:'ÈÉ®Èï∑', n:1, s:4.5, p:1.0, sz:40}], walls: [{x:200,y:150,w:40,h:280}, {x:650,y:0,w:40,h:250}] }
    ]},
    { id: "m2", title: "MISSION 2: Á§æÈï∑ÂÆ§", floors: [
        { target: 3, bosses: [{t:'ÈÉ®Èï∑', n:2, s:4.0, p:1.2, sz:40}], walls: [{x:100,y:120,w:700,h:40}] },
        { target: 1, bosses: [{t:'Á§æÈï∑', n:1, s:6.0, p:5.0, sz:65}], walls: [{x:430,y:80,w:40,h:250}] }
    ]}
];

let selectedM = null, currentFloor = 0, gameActive = false, totalTime = 0, lastFrame = 0;
let player = { x: 50, y: 200, sz: 30, speed: 6.5, item: null }, mental = 100, evidence = [], bosses = [], walls = [], items = [], sleepTimer = 0;

// --- Ëá™Âãï„Çπ„Ç±„Éº„É™„É≥„Ç∞Èñ¢Êï∞ ---
function resize() {
    const wrap = document.getElementById('game-wrapper');
    const scale = Math.min(window.innerWidth / 900, window.innerHeight / 650);
    wrap.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', resize);
window.addEventListener('load', resize);
resize();

function showScreen(s) {
    document.querySelectorAll('.screen').forEach(x => x.classList.add('hidden'));
    document.getElementById('screen-' + s).classList.remove('hidden');
    if(s === 'title') renderMissions();
}

function renderMissions() {
    const list = document.getElementById('mission-list');
    list.innerHTML = "";
    missions.forEach(m => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = m.title;
        b.onclick = () => {
            selectedM = m; currentFloor = 0; totalTime = 0;
            document.getElementById('ready-mission-name').textContent = m.title;
            displayRanking(m.id, 'mission-ranking');
            showScreen('ready');
        };
        list.appendChild(b);
    });
}

function startGame() { showScreen('game'); initFloor(); }

function initFloor() {
    const f = selectedM.floors[currentFloor];
    gameActive = true; player.x = 40; player.y = 200; mental = 100; sleepTimer = 0;
    walls = JSON.parse(JSON.stringify(f.walls));
    evidence = Array.from({length: f.target}, () => ({ x: 200+Math.random()*600, y: 50+Math.random()*330, active: true }));
    items = [{ x: 300+Math.random()*400, y: 100+Math.random()*230, type: Math.random()>0.5?'üî®':'üå¨Ô∏è', active: true }];
    bosses = f.bosses.flatMap(b => Array.from({length: b.n}, () => ({
        t: b.t, x: 750, y: Math.random()*350, sy: b.s, sz: b.sz, p: b.p, found: false
    })));
    lastFrame = Date.now();
    requestAnimationFrame(loop);
}

function useItem() {
    if(!player.item) return;
    if(player.item === 'üî®') walls = []; else sleepTimer = 300;
    player.item = null;
    document.getElementById('item-slot').textContent = "ITEM: EMPTY";
}

function loop() {
    if(!gameActive) return;
    const now = Date.now();
    const dt = (now - lastFrame) / 1000;
    lastFrame = now;
    totalTime += dt;
    if(sleepTimer > 0) sleepTimer--;

    let nx = player.x, ny = player.y;
    if(keys.Up) ny -= player.speed; if(keys.Down) ny += player.speed;
    if(keys.Left) nx -= player.speed; if(keys.Right) nx += player.speed;
    
    nx = Math.max(0, Math.min(870, nx)); ny = Math.max(0, Math.min(400, ny));
    if(!walls.some(w => nx < w.x+w.w && nx+player.sz > w.x && player.y < w.y+w.h && player.y+player.sz > w.y)) player.x = nx;
    if(!walls.some(w => player.x < w.x+w.w && player.x+player.sz > w.x && ny < w.y+w.h && ny+player.sz > w.y)) player.y = ny;

    if(sleepTimer <= 0) {
        bosses.forEach(b => {
            if(b.t === 'Á§æÈï∑') {
                let dx = player.x-b.x, dy = player.y-b.y, d = Math.hypot(dx,dy);
                let hasWall = walls.some(w => {
                    for(let i=0; i<1; i+=0.2) {
                        let px=b.x+dx*i, py=b.y+dy*i;
                        if(px>w.x && px<w.x+w.w && py>w.y && py<w.y+w.h) return true;
                    } return false;
                });
                if(d < 350 && !hasWall) { b.found = true; b.x += (dx/d)*b.sy; b.y += (dy/d)*b.sy; }
                else { b.found = false; b.y += b.sy; if(b.y<0 || b.y>430-b.sz) b.sy *= -1; }
            } else { b.y += b.sy; if(b.y<0 || b.y>430-b.sz) b.sy *= -1; }
            if(Math.hypot(player.x-b.x, player.y-b.y) < b.sz) mental -= b.p;
        });
    }

    evidence.forEach(e => { if(e.active && Math.hypot(player.x-e.x, player.y-e.y)<35) e.active = false; });
    items.forEach(i => { if(i.active && Math.hypot(player.x-i.x, player.y-i.y)<35) { i.active = false; player.item = i.type; document.getElementById('item-slot').textContent = "ITEM: " + (i.type==='üî®'?'HAMMER':'SLEEP'); }});

    document.getElementById('time-val').textContent = totalTime.toFixed(1);
    document.getElementById('mtl-val').textContent = Math.max(0, Math.floor(mental));
    document.getElementById('ev-val').textContent = `${evidence.filter(e=>!e.active).length}/${evidence.length}`;

    if(player.x > 860 && evidence.every(e=>!e.active)) {
        if(currentFloor < selectedM.floors.length - 1) { currentFloor++; initFloor(); return; }
        else { finish(true); return; }
    }
    if(mental <= 0) { finish(false); return; }

    draw();
    requestAnimationFrame(loop);
}

function draw() {
    ctx.clearRect(0,0,900,430);
    walls.forEach(w => { ctx.fillStyle="#444"; ctx.fillRect(w.x,w.y,w.w,w.h); });
    evidence.forEach(e => { if(e.active) { ctx.fillStyle="#ff0"; ctx.fillRect(e.x,e.y,20,20); }});
    items.forEach(i => { if(i.active) { ctx.fillStyle="#0af"; ctx.fillRect(i.x,i.y,30,30); ctx.fillStyle="#fff"; ctx.font="12px Arial"; ctx.fillText(i.type, i.x+5, i.y+20); }});
    bosses.forEach(b => {
        ctx.fillStyle = sleepTimer > 0 ? "#44f" : (b.t==='Á§æÈï∑'?"#f00":"#f0f");
        ctx.fillRect(b.x,b.y,b.sz,b.sz);
        if(b.found && sleepTimer<=0) { ctx.fillStyle="#f00"; ctx.font="bold 25px Arial"; ctx.fillText("!", b.x+b.sz/2-5, b.y-10); }
        if(sleepTimer > 0) { ctx.fillStyle="#fff"; ctx.font="12px Arial"; ctx.fillText("Zzz", b.x, b.y-10); }
    });
    ctx.fillStyle="#0f0"; ctx.fillRect(player.x,player.y,player.sz,player.sz);
    ctx.fillStyle = evidence.every(e=>!e.active) ? "#0f0" : "#222"; ctx.fillRect(880,0,20,430);
}

function finish(clear) {
    gameActive = false; showScreen('result');
    if(clear) {
        document.getElementById('result-title').textContent = "SUCCESS!";
        document.getElementById('result-text').textContent = `TIME: ${totalTime.toFixed(2)}s`;
        saveRanking(selectedM.id, totalTime, myCodename);
    } else {
        document.getElementById('result-title').textContent = "FAILED...";
        document.getElementById('result-text').textContent = "AGENT LOST.";
    }
    displayRanking(selectedM.id, 'final-ranking');
}

function saveRanking(id, time, name) {
    let s = JSON.parse(localStorage.getItem('r_'+id)||'[]');
    s.push({name, time}); s.sort((a,b)=>a.time-b.time);
    localStorage.setItem('r_'+id, JSON.stringify(s.slice(0,5)));
}
function displayRanking(id, elId) {
    let s = JSON.parse(localStorage.getItem('r_'+id)||'[]');
    document.getElementById(elId).innerHTML = "TOP AGENTS:<br>" + s.map((x,i)=>`<div class="rank-row"><span>${i+1}.${x.name}</span><span>${x.time.toFixed(1)}s</span></div>`).join("");
}

showScreen('title');
</script>
</body>
</html>